<div class="w-full h-full flex flex-row animate-fade-in relative overflow-hidden bg-white select-none">
  
  <!-- Paper Texture Overlay (Global) -->
  <div class="absolute inset-0 pointer-events-none opacity-[0.05] z-0" style="background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png')"></div>

  <!-- LEFT PANEL: CONTROLS & FILTERS (35% Width) -->
  <div class="w-[35%] min-w-[320px] border-r border-stone-200 bg-stone-50/80 flex flex-col z-10 pt-16 select-none">
    
    <!-- Header Section -->
    <div class="px-5 pb-5 border-b border-stone-200 flex flex-col gap-4 flex-shrink-0">
       
       <!-- Title -->
       <div>
         <h3 class="font-sans text-[10px] uppercase tracking-[0.4em] text-stone-600 font-bold cursor-default">{{ lang.t().wizard_title }}</h3>
       </div>

       <!-- Expertise Selector -->
       <div class="flex flex-col gap-1">
          <label class="font-sans text-[9px] uppercase tracking-widest text-stone-600 font-bold cursor-default">{{ lang.t().wizard_expertise_label }}</label>
          <div class="relative">
            <select [(ngModel)]="expertise" class="w-full bg-white border border-stone-300 p-2 font-sans text-xs uppercase tracking-wider text-stone-900 font-semibold focus:border-stone-800 outline-none appearance-none rounded-none cursor-pointer hover:bg-stone-100 transition-colors">
              <option value="Principiante">{{ lang.t().exp_beginner }}</option>
              <option value="Didatta">{{ lang.t().exp_teacher }}</option>
              <option value="Appassionato">{{ lang.t().exp_enthusiast }}</option>
              <option value="Professionista">{{ lang.t().exp_pro }}</option>
            </select>
            <!-- Custom Arrow -->
            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-stone-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>
       </div>

       <!-- ACTIVE FILTERS AREA -->
       <div class="flex flex-col gap-2 mt-2">
          <span class="font-sans text-[9px] uppercase tracking-widest text-stone-600 font-bold cursor-default">{{ lang.t().filter_active_label }}</span>
          <div class="flex flex-wrap gap-1.5 min-h-[24px]">
             @for (key of getSelectedLabels(); track key) {
                <button (click)="toggleConstraint(key)" class="bg-stone-800 text-white text-[9px] uppercase tracking-widest px-2 py-1 flex items-center gap-1.5 hover:bg-stone-600 transition-colors shadow-sm cursor-pointer">
                   {{ lang.getOptionLabel(key) }}
                   <span class="text-stone-400 font-bold">&times;</span>
                </button>
             }
             @if (getSelectedLabels().length === 0) {
               <span class="text-[10px] italic text-stone-600 font-serif p-1 cursor-default">Nessuna direttiva attiva...</span>
             }
          </div>
       </div>
    </div>

    <!-- Scrollable Filter Grid -->
    <div class="overflow-y-auto p-5 flex-grow custom-scrollbar">
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
         
         <!-- Group 1 -->
         <div class="flex flex-col gap-1.5">
            <div class="flex justify-between items-center pb-1 border-b border-stone-300">
               <span class="font-sans text-[9px] uppercase tracking-widest text-stone-800 font-bold truncate pr-2 cursor-default">{{ lang.t().filter_cat_diet }}</span>
               <button (click)="randomizeCategory('group1')" [disabled]="isRegenerating().group1" class="text-stone-600 hover:text-stone-900 transition-colors p-1 cursor-pointer" title="Rigenera">
                  @if (isRegenerating().group1) {
                    <div class="w-3.5 h-3.5 border-2 border-stone-400 border-t-stone-900 rounded-full animate-spin"></div>
                  } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                  }
               </button>
            </div>
            <div class="flex flex-col gap-1">
               @for (optKey of visibleOptions().group1; track optKey) {
                  <button (click)="toggleConstraint(optKey)"
                     class="text-left px-2 py-1 border text-[9px] uppercase tracking-wider transition-all duration-200 truncate font-semibold cursor-pointer"
                     [class.bg-stone-800]="isSelected(optKey)"
                     [class.text-white]="isSelected(optKey)"
                     [class.border-stone-800]="isSelected(optKey)"
                     [class.bg-white]="!isSelected(optKey)"
                     [class.text-stone-700]="!isSelected(optKey)"
                     [class.border-stone-300]="!isSelected(optKey)"
                     [class.hover:border-stone-500]="!isSelected(optKey)"
                     [class.hover:text-stone-900]="!isSelected(optKey)">
                     {{ lang.getOptionLabel(optKey) }}
                  </button>
               }
            </div>
         </div>
  
         <!-- Group 2 -->
         <div class="flex flex-col gap-1.5">
            <div class="flex justify-between items-center pb-1 border-b border-stone-300">
               <span class="font-sans text-[9px] uppercase tracking-widest text-stone-800 font-bold truncate pr-2 cursor-default">{{ lang.t().filter_cat_tech }}</span>
               <button (click)="randomizeCategory('group2')" [disabled]="isRegenerating().group2" class="text-stone-600 hover:text-stone-900 transition-colors p-1 cursor-pointer">
                  @if (isRegenerating().group2) {
                    <div class="w-3.5 h-3.5 border-2 border-stone-400 border-t-stone-900 rounded-full animate-spin"></div>
                  } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                  }
               </button>
            </div>
            <div class="flex flex-col gap-1">
               @for (optKey of visibleOptions().group2; track optKey) {
                  <button (click)="toggleConstraint(optKey)"
                     class="text-left px-2 py-1 border text-[9px] uppercase tracking-wider transition-all duration-200 truncate font-semibold cursor-pointer"
                     [class.bg-stone-800]="isSelected(optKey)"
                     [class.text-white]="isSelected(optKey)"
                     [class.border-stone-800]="isSelected(optKey)"
                     [class.bg-white]="!isSelected(optKey)"
                     [class.text-stone-700]="!isSelected(optKey)"
                     [class.border-stone-300]="!isSelected(optKey)"
                     [class.hover:border-stone-500]="!isSelected(optKey)"
                     [class.hover:text-stone-900]="!isSelected(optKey)">
                     {{ lang.getOptionLabel(optKey) }}
                  </button>
               }
            </div>
         </div>
  
         <!-- Group 3 -->
         <div class="flex flex-col gap-1.5">
            <div class="flex justify-between items-center pb-1 border-b border-stone-300">
               <span class="font-sans text-[9px] uppercase tracking-widest text-stone-800 font-bold truncate pr-2 cursor-default">{{ lang.t().filter_cat_mood }}</span>
               <button (click)="randomizeCategory('group3')" [disabled]="isRegenerating().group3" class="text-stone-600 hover:text-stone-900 transition-colors p-1 cursor-pointer">
                  @if (isRegenerating().group3) {
                    <div class="w-3.5 h-3.5 border-2 border-stone-400 border-t-stone-900 rounded-full animate-spin"></div>
                  } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                  }
               </button>
            </div>
            <div class="flex flex-col gap-1">
               @for (optKey of visibleOptions().group3; track optKey) {
                  <button (click)="toggleConstraint(optKey)"
                     class="text-left px-2 py-1 border text-[9px] uppercase tracking-wider transition-all duration-200 truncate font-semibold cursor-pointer"
                     [class.bg-stone-800]="isSelected(optKey)"
                     [class.text-white]="isSelected(optKey)"
                     [class.border-stone-800]="isSelected(optKey)"
                     [class.bg-white]="!isSelected(optKey)"
                     [class.text-stone-700]="!isSelected(optKey)"
                     [class.border-stone-300]="!isSelected(optKey)"
                     [class.hover:border-stone-500]="!isSelected(optKey)"
                     [class.hover:text-stone-900]="!isSelected(optKey)">
                     {{ lang.getOptionLabel(optKey) }}
                  </button>
               }
            </div>
         </div>
  
         <!-- Group 4 -->
         <div class="flex flex-col gap-1.5">
            <div class="flex justify-between items-center pb-1 border-b border-stone-300">
               <span class="font-sans text-[9px] uppercase tracking-widest text-stone-800 font-bold truncate pr-2 cursor-default">{{ lang.t().filter_cat_log }}</span>
               <button (click)="randomizeCategory('group4')" [disabled]="isRegenerating().group4" class="text-stone-600 hover:text-stone-900 transition-colors p-1 cursor-pointer">
                  @if (isRegenerating().group4) {
                    <div class="w-3.5 h-3.5 border-2 border-stone-400 border-t-stone-900 rounded-full animate-spin"></div>
                  } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                  }
               </button>
            </div>
            <div class="flex flex-col gap-1">
               @for (optKey of visibleOptions().group4; track optKey) {
                  <button (click)="toggleConstraint(optKey)"
                     class="text-left px-2 py-1 border text-[9px] uppercase tracking-wider transition-all duration-200 truncate font-semibold cursor-pointer"
                     [class.bg-stone-800]="isSelected(optKey)"
                     [class.text-white]="isSelected(optKey)"
                     [class.border-stone-800]="isSelected(optKey)"
                     [class.bg-white]="!isSelected(optKey)"
                     [class.text-stone-700]="!isSelected(optKey)"
                     [class.border-stone-300]="!isSelected(optKey)"
                     [class.hover:border-stone-500]="!isSelected(optKey)"
                     [class.hover:text-stone-900]="!isSelected(optKey)">
                     {{ lang.getOptionLabel(optKey) }}
                  </button>
               }
            </div>
         </div>
  
      </div>
    </div>
  </div>


  <!-- RIGHT PANEL: CHAT INTERFACE (65% Width) -->
  <div class="flex-1 flex flex-col bg-white z-10 relative h-full pt-8 select-none">
    
    <!-- Chat History -->
    <div class="flex-grow overflow-y-auto p-6 space-y-4 scroll-smooth" #chatContainer>
      @for (msg of messages(); track $index) {
        <div class="flex w-full flex-col" [class.items-end]="msg.role === 'user'">
          
          <!-- Maestro Message -->
          @if (msg.role === 'model') {
            <div class="max-w-[85%] flex gap-3 animate-fade-in">
              <div class="w-7 h-7 rounded-full bg-stone-100 flex items-center justify-center flex-shrink-0 border border-stone-300 mt-1">
                <span class="font-serif italic font-bold text-stone-600 text-xs">M</span>
              </div>
              <div class="flex flex-col gap-2">
                 <!-- Main Text -->
                 <div class="bg-stone-50 border border-stone-200 p-4 shadow-sm rounded-tr-lg rounded-br-lg rounded-bl-lg">
                   <p class="font-serif text-base leading-relaxed text-stone-800 italic select-text cursor-text">{{ msg.content }}</p>
                 </div>
                 
                 <!-- SUGGESTIONS/QUESTIONS -->
                 @if (msg.suggestions && msg.suggestions.length > 0) {
                   <div class="flex flex-col gap-2 mt-1 items-start">
                     
                     <div class="flex justify-between w-full items-center">
                       <span class="text-[9px] uppercase tracking-widest text-stone-400">Suggerimenti</span>
                       @if ($last && !isRegenerating().questions) {
                          <button (click)="refreshQuestions()" class="text-stone-400 hover:text-stone-800 transition-colors" title="Nuove Domande">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                             </svg>
                          </button>
                       }
                       @if ($last && isRegenerating().questions) {
                          <div class="w-3 h-3 border-2 border-stone-300 border-t-stone-800 rounded-full animate-spin"></div>
                       }
                     </div>

                     <div class="flex flex-wrap gap-2">
                        @for (question of msg.suggestions; track question) {
                          <button (click)="selectSuggestion(question)" 
                                  class="text-left bg-white border border-stone-200 hover:border-stone-800 hover:bg-stone-50 text-stone-600 hover:text-stone-900 px-3 py-2 rounded-sm shadow-sm transition-all text-xs font-serif italic max-w-md">
                            {{ question }}
                          </button>
                        }
                     </div>
                   </div>
                 }
              </div>
            </div>
          }

          <!-- User Message -->
          @if (msg.role === 'user') {
            <div class="max-w-[85%] animate-fade-in">
               <div class="bg-stone-800 text-stone-100 p-3 shadow-md rounded-tl-lg rounded-bl-lg rounded-br-lg text-right">
                <p class="font-serif text-base leading-relaxed select-text cursor-text">{{ msg.content }}</p>
              </div>
            </div>
          }
        </div>
      }

      @if (isLoading()) {
        <div class="flex w-full animate-fade-in">
          <div class="flex gap-3 items-center">
             <div class="w-6 h-6 rounded-full bg-stone-50 flex items-center justify-center border border-stone-200 animate-pulse">
                <span class="font-serif italic text-stone-400 text-xs">...</span>
             </div>
             <span class="text-[10px] uppercase tracking-widest text-stone-400">{{ lang.t().wizard_thinking }}</span>
          </div>
        </div>
      }
    </div>

    <!-- Footer: Input Area -->
    <div class="p-4 border-t border-stone-200 bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
      <form (ngSubmit)="sendMessage()" class="relative">
        <div class="flex gap-3 items-end">
          <div class="flex-grow relative">
             <textarea 
                 [formControl]="inputControl"
                 name="userInput"
                 [disabled]="isLoading() || isMaterializing()"
                 rows="2"
                 class="w-full bg-stone-50 border border-stone-300 p-3 pr-12 font-serif text-lg text-stone-800 focus:border-stone-800 focus:bg-white transition-all outline-none placeholder-stone-400 resize-none rounded-sm select-text cursor-text"
                 [placeholder]="lang.t().wizard_placeholder"
                 (keydown.enter)="$event.preventDefault(); sendMessage()"></textarea>
                 
             <!-- MIC BUTTON -->
             <button type="button"
                     (click)="toggleRecording()"
                     class="absolute right-2 top-2 p-2 text-stone-400 hover:text-red-600 transition-colors rounded-full hover:bg-red-50"
                     [class.text-red-600]="isRecording()"
                     [class.animate-pulse]="isRecording()"
                     title="Dettatura Vocale">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                </svg>
             </button>
          </div>
          
          <button type="submit" 
                  [disabled]="!inputControl.value?.trim() || isLoading() || isMaterializing()"
                  class="bg-stone-100 text-stone-800 p-3 h-[54px] w-[54px] flex items-center justify-center hover:bg-stone-200 transition-colors disabled:opacity-50 border border-stone-200 rounded-sm cursor-pointer">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
              </svg>
          </button>

          <button type="button" 
                  (click)="materializeVision()"
                  [disabled]="isMaterializing() || isLoading()"
                  class="bg-stone-900 text-white px-4 h-[54px] font-sans text-[9px] uppercase tracking-[0.2em] hover:bg-stone-700 transition-all shadow-xl disabled:opacity-70 whitespace-nowrap rounded-sm flex flex-col items-center justify-center min-w-[100px] cursor-pointer">
             @if (isMaterializing()) {
               <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mb-1"></div>
               {{ lang.t().wizard_solidifying }}
             } @else {
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mb-1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
              </svg>
               {{ lang.t().wizard_materialize }}
             }
          </button>
        </div>
      </form>
    </div>

  </div>

</div>
<div class="min-h-screen relative">
  
  <!-- LANGUAGE SELECTOR (Top Left) - ONLY IN LANDING MODE -->
  @if (appState() === 'LANDING') {
    <div class="absolute top-0 left-0 p-4 z-[60] flex gap-2 animate-fade-in print:hidden">
      <button (click)="setLang('IT')" 
              class="font-sans text-[10px] font-bold uppercase tracking-widest px-2 py-1 transition-colors cursor-pointer"
              [class.text-stone-900]="isLang('IT')"
              [class.text-stone-400]="!isLang('IT')"
              [class.border-b-2]="isLang('IT')"
              [class.border-stone-900]="isLang('IT')"
              [class.border-transparent]="!isLang('IT')">
        ITA
      </button>
      <div class="w-px h-4 bg-stone-300 self-center"></div>
      <button (click)="setLang('EN')" 
              class="font-sans text-[10px] font-bold uppercase tracking-widest px-2 py-1 transition-colors cursor-pointer"
              [class.text-stone-900]="isLang('EN')"
              [class.text-stone-400]="!isLang('EN')"
              [class.border-b-2]="isLang('EN')"
              [class.border-stone-900]="isLang('EN')"
              [class.border-transparent]="!isLang('EN')">
        ENG
      </button>
    </div>
  }

  <!-- AUTHENTICATED HEADER ACTIONS (Top Right) -->
  @if (isAuthenticated()) {
    <div class="absolute top-0 right-0 p-4 z-[60] animate-fade-in flex items-center gap-2 print:hidden">
      @if (appState() === 'LANDING') {
        <button (click)="openApiKeyModal()"
                class="font-sans text-[10px] font-bold uppercase tracking-widest px-3 py-1 border border-stone-300 text-stone-600 hover:text-stone-900 hover:border-stone-900 bg-white transition-colors cursor-pointer">
          Change API Key
        </button>
      }
      <button (click)="logout()"
              class="font-sans text-[10px] font-bold uppercase tracking-widest px-3 py-1 text-stone-500 hover:text-red-600 transition-colors cursor-pointer">Esci</button>
    </div>
  }

  @if (appState() !== 'LANDING') {
    <!-- BACK BUTTON -->
    <header class="absolute top-0 left-0 p-4 z-50 print:hidden">
      <button (click)="backToHome()" 
        class="font-sans text-xs uppercase tracking-widest text-stone-500 hover:text-stone-900 transition-colors px-4 py-2 font-bold cursor-pointer">
        &larr; {{ lang.t().back_home }}
      </button>
    </header>
  }

  @switch (appState()) {
    @case ('LANDING') {
      <app-landing (modeSelected)="selectMode($event)"></app-landing>
    }
    @case ('CREATION') {
      @if (creationMode() === 'CALCULATOR') {
        <app-calculator></app-calculator>
      } @else {
        <app-dashboard [mode]="creationMode()"></app-dashboard>
      }
    }
  }

  <!-- LOGIN OVERLAY (blocks app until authenticated) -->
  @if (!isAuthenticated()) {
    <div class="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-md rounded-md shadow-2xl p-6">
        <h2 class="font-serif text-xl text-stone-900 mb-1">Accedi per continuare</h2>
        <p class="font-sans text-xs text-stone-500 mb-4">Per usare l'app è richiesto l'accesso con Google. L'API Key è opzionale e vale solo per questa sessione.</p>
        <div class="flex justify-center mb-6">
          <div class="w-full flex flex-col items-center gap-2">
            <div #googleBtn class="min-h-[40px]"></div>
            @if (auth.gisError()) {
              <div class="text-[11px] text-red-600 text-center px-2">
                {{ auth.gisError() }}
              </div>
              <button (click)="retryRenderGoogle()"
                      class="px-3 py-1 border border-stone-300 text-stone-700 font-sans text-[10px] uppercase tracking-widest hover:border-stone-900 hover:text-stone-900 transition-colors cursor-pointer">Riprova</button>
            }
          </div>
        </div>
        <div class="h-px w-full bg-stone-200 mb-4"></div>
        <div>
          <label class="font-sans text-[11px] uppercase tracking-widest text-stone-500">API Key (sessione corrente)</label>
          <div class="mt-2">
            <input #overlayApiInput type="password" placeholder="Incolla qui la tua Google API Key"
                   class="w-full bg-white border border-stone-300 focus:border-stone-900 outline-none p-3 font-mono text-xs mb-3" />
            <div class="flex justify-between items-center">
              <button (click)="saveApiKeyFrom(overlayApiInput)"
                      class="px-4 py-2 bg-stone-900 text-white font-sans text-xs uppercase tracking-widest hover:bg-stone-700 transition-colors cursor-pointer">Usa per questa sessione</button>
              <span class="text-[11px] text-stone-400">Non viene salvata nel browser</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- API KEY MODAL -->
  @if (showApiKeyModal) {
    <div class="fixed inset-0 z-[80] flex items-center justify-center bg-black/40">
      <div class="bg-white w-[90%] max-w-md rounded-md shadow-2xl p-6">
        <h2 class="font-serif text-xl text-stone-900 mb-2">Change API Key</h2>
        <p class="font-sans text-xs text-stone-500 mb-4">Chiave attuale: <span class="font-mono">{{ maskedStoredApiKey() }}</span></p>
        @if (errorApiKey) {
          <div class="text-red-600 text-xs mb-2">{{ errorApiKey }}</div>
        }
        <input #apiInput type="password" placeholder="Incolla qui la tua Google API Key"
               class="w-full bg-white border border-stone-300 focus:border-stone-900 outline-none p-3 font-mono text-xs mb-4" />
        <div class="flex justify-between items-center">
          <div class="flex gap-2">
            <button (click)="saveApiKeyFrom(apiInput)"
                    class="px-4 py-2 bg-stone-900 text-white font-sans text-xs uppercase tracking-widest hover:bg-stone-700 transition-colors cursor-pointer">Salva</button>
            <button (click)="closeApiKeyModal()"
                    class="px-4 py-2 border border-stone-300 text-stone-700 font-sans text-xs uppercase tracking-widest hover:border-stone-900 hover:text-stone-900 transition-colors cursor-pointer">Annulla</button>
          </div>
          <button (click)="clearApiKey()"
                  class="px-3 py-2 text-xs text-stone-500 hover:text-red-600 transition-colors cursor-pointer">Rimuovi</button>
        </div>
        <div class="mt-3 text-[11px] text-stone-400">Nota: l'API Key non viene salvata nel browser e si cancella alla chiusura/refresh.</div>
      </div>
    </div>
  }
</div>